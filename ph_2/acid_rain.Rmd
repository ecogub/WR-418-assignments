---
title: "Acid Rain"
author: "Nick Gubbins"
date: "2/4/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(feather)
library(dataRetrieval)
```

# Acid Rain

While rain is naturally acidic due to the carbonation of water (more on that 
later in the semester), a polluted atmosphere can increase the acidity of 
rainfall. Adding acid to a land surface can displace soil cations and change 
solute chemistry in downstream waterways. Burning fossil fuels was, and is,
major source of air pollution. The [Clean Air Act Amendments of 1990](https://www.epa.gov/sites/default/files/2015-11/documents/the_clean_air_act_-_highlights_of_the_1990_amendments.pdf) were instrumental in tackling polluted air in the US. The amendments capped total
emissions of acidic nitrogen oxides and sulfur dioxides, establishing a 
tradeable, emissions credit pool for power plants. You can read more about the 
long-term effects of these efforts [in this informative paper.](https://www.esf.edu/efb/mitchell/Class%20Readings/Nat.401.575.578.pdf)

## Hubbard Brook 

The [Hubbard Brook Experimental Forest (HBEF)](https://hubbardbrook.org/hubbard-brook-research-focus) is a long-running ecosystem 
study located in New Hampshire.The study has several small streams running 
through forested watersheds. Different treatments have been applied to some of 
the watersheds, but this unit we will be looking at a reference site, [watershed 6](https://hubbardbrook.org/watersheds/watershed-6). W6 is located in the industrail Northeast of the US and has a record beginning in 1963, making it ideal to observe the effects of acid rain.


# Working with files in R

## The working directory
When referencing file paths in R, it is important to know what directory you 
are working in. A directory is just another name for folder level. 

Let's check ours now.

```{r, include = T}
getwd()
```

When working with data files, it's convenient to set our working directory. This
lets us use relative file paths when referencing files moving forward. It also
makes it easier for others to use our code. They will only need to change one
line to use our data structure on their computer. To do so, we use the function
'setwd()', giving the function the file path of the script. In my case it's
a little convoluted due to Dropbox. Yours will likely be shorter.

```{r, include = T}
setwd("C:/Users/gubbi/Dropbox/My PC (DESKTOP-RMMTJHU)/Documents/WR 418/WR-418-assignments/ph_2")
```


## Reading in files
Now that our working directory is set, we can read in our data files. The files
we are using have been downloaded from [Macrosheds](macrosheds.org), which uses
a file format called 'feather'. For those of you that have used R before, you 
are probably familiar with the function 'read.csv()'. This works basically the
same, but for a more efficient file format. 

To read in the file, we will supply the 'read_feather()' function the location 
of the file relative to our working directory.
```{r, include = T}
q <- read_feather('data/w6_discharge.feather')
head(q)
```

See how I didn't have to type out "C:/Users/gubbi/Dropbox/My PC (DESKTOP-RMMTJHU)/Documents/WR 418/WR-418-assignments/ph_2/data/w6_discharge.feather" again? 
This saves a lot of time and space in longer workflows and makes editing your 
code much quicker.

## Long vs wide data
There are many different ways data can be stored. One simple data dichotomy is 
wide vs long. Wide data has many columns, usually with each variable in a 
column. The data retrieved from the USGS is in wide format. Long data has 
many rows, with a column of variables describing other values. The data 
downloaded from Macrosheds comes in a long format. To switch between them we 
can use the functions 'pivot_wider()' and 'pivot_longer()'. 

Here is an example of pivoting USGS data from wide to long. First, I'll 
retrieve the gauge height (local water elevation) and discharge data from a 
favorite gauge of mine, Cicero Creek at Arcadia, IN.
```{r, include=TRUE}
cicero <- readNWISuv(siteNumbers = '03349510',
                     parameterCd = c('00060', '00065'),
                     startDate = '2017-10-01',
                     endDate = '2018-9-30') %>% 
  rename(q_cfs = 'X_00060_00000',
         gh_ft = 'X_00065_00000') %>%
  select(dateTime, gh_ft, q_cfs)

```

Next, I will use 'pivot_longer()'. The 'cols' argument denotes what to pivot 
(in this case everything but the dateTime column), the 'names_to' is the new 
column to put the old column names as values, and the 'values_to' argument is 
the new column to put the old column values in. 'Pivot_wider()' works in a similar way.
```{r, include=TRUE}
cicero_long <- cicero %>%
  pivot_longer(cols = -dateTime,
               names_to = 'var',
               values_to = 'val')

head(cicero_long)

```

## Fitting models in R
while we won't be going into detail on modeling in the course, calculating 
simple lines of best fit is a common tool in the sciences. Let's model the 
relationship between gauge height and discharge in out model.

First let's look at the data visually.
```{r}
ggplot(cicero, aes(x = gh_ft, y = q_cfs))+
         geom_point()
```
There's a pretty clear relationship there. Let's try a linear fit on it. To 
make a simple **l**inear **m**odel (the classic y=mx+b), we use the function 
'lm()'. Then the function 'summary()' to view the details.
```{r}
cicero_model <- lm(cicero$q_cfs ~ cicero$gh_ft)
summary(cicero_model)
```
This output tells us our R-squared is 0.92, with a slope of 247 cfs/ft and an 
intercept of -740 cfs. 

We can replicate this in ggplot2 using geom_smooth.
```{r, include = TRUE}
ggplot(cicero, aes(x = gh_ft, y = q_cfs))+
        geom_point()+
        geom_smooth(method = 'lm', forumla = y ~ x)
```

Ratings are more complicted than a simple linear relationship, so this line is 
more than sensible.

# Assignment

## Q0: 
**If you're working on this from your own computer**, set your working directory 
to where this file's directory. Skip this question if you are working in the 
Rstudio cloud IDE as it has already been done for you. **This should be the last** 
**time either group uses a full file path in this assignment.**

```{r}
setwd("~/WR 418/WR-418-assignments/ph_2")
```


## Q1:
Read in the the '.feather' data files for Q and stream chemistry at W6.

```{r}
q <- read_feather('data/w6_discharge.feather')
chem <- read_feather('data/w6_chemistry.feather')

```

## Q2: 
Make your data useful and understood.

### Part A:
Combine the chemistry and discharge data objects. Remove the columns 'ms_status'
, 'ms_interp', and 'val_err' (these are data quality flags we won't be using now).
(Hint: look into the ['bind'](https://stat.ethz.ch/R-manual/R-devel/library/base/html/cbind.html) functions.)

```{r}
cq <- rbind(chem, q) %>%
    select(-c('ms_status', 'ms_interp','val_err'))
```

### Part B:
Describe (in text) the structure of your new, combined object. What are the 
columns and what do they contain? Is your data in a long or wide format? When 
does your dataset begin and end?

### Part C:
Use the 'unique()' function to list all variables represented in the dataset.
```{r}
unique(cq$var)
```


## Q3:

### Part A:
Plot a timeseries of pH at HBEF W6. Color the data by whether it is pre or post
Clean Air Act Amendments of 1990, or use a vertical line to denote its passage.
Make the figure look presentable, with labels, a title, and a descriptive 
caption.(Hint: the code for pH in this dataset is 'GN_pH'.)


```{r}
ggplot(filter(cq, var == 'GN_pH'), aes(x = datetime, y = val, color = datetime>as.POSIXct('1990-11-15')))+
    geom_line()+
    labs(y = 'W6 Stream pH',
         x = '',
         color = 'Clean Air Act Amendments of 1990')+
  scale_color_manual(values = c('black', 'red'),
                     labels = c('Pre', 'Post'))+
  theme(legend.position = 'bottom')
    
```

### Part B:
Fit two linear models, one to the data before and and the other after the 
passage of the Clean Air Act Amendments of 1990.Display your results using the 
'summary()' function.

```{r}
# trim data
cq_model <- cq %>%
  filter(var == 'GN_pH') %>%
  select(datetime, val) %>%
  na.omit() %>%
  mutate(post_cca = 1*(datetime>as.POSIXct('1990-11-15')))

# calculate pre CCA
pre_model <-lm(cq_model$val[cq_model$post_cca==0] ~ cq_model$datetime[cq_model$post_cca==0])

summary(pre_model)

# calculate post CCA
post_model <-lm(cq_model$val[cq_model$post_cca==1] ~ cq_model$datetime[cq_model$post_cca==1])

summary(post_model)
```

### Part C:
Briefly interpret your model outputs in context.

## Q5
Aluminum is highly abundant (~7% of Earth's crust) and is toxic to life. The 
predominant form it takes in solution is pH dependent, with the Al^(3+) ion the
most toxic to aquatic life. We will cover the exact mechanism of this pH 
dependence later in the semester. For now, let's just try and observe the effect. 

### Part A: 
Pivot your data from long format, to wide.
```{r}
cq_wide <- pivot_wider(cq, id_cols = c(datetime, site_code), 
                       names_from = var, 
                       values_from = val)
```

### Part B: 
Make a scatterplot of Al vs pH. (Hint: the code for Al in this dataset is 'GN_Al_ICP')
Make the figure look presentable, with labels, a title, and a descriptive caption. 
(Reminder: your final .html should *not* show warnings, messages, errors, etc.)
```{r}
ggplot(cq_wide, aes(x = GN_pH, y = GN_Al_ICP))+
    geom_point()
```

## Q6

### Part A:
What is the effect of reducing acid rain on in aluminum toxicity in W6?

### Part B:
What other factors may be acting on as a control on aluminum at W6?


## Bonus Question
Create a model describing the relationship between pH and Al at HBEF (it is not
simple linear). Add your model to the graph from Q5.
```{r}
cq_model2 <- cq_wide %>%
  select(GN_Al_ICP, GN_pH) %>%
  na.omit()

model2 <- lm(log10(cq_model2$GN_Al_ICP)~cq_model2$GN_pH)
summary(model2)

ggplot(cq_model2, aes(x = GN_pH, y = GN_Al_ICP))+
    geom_point()+
    scale_y_log10()+
  geom_smooth(method = 'lm', 
              formula = y ~ x,
              se = T) +
  labs(x = 'pH',
       y = 'log([Al]) mg/l')

```
