---
title: "Acid Rain"
author: "Nick Gubbins"
date: "2/4/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(feather)
```

# Acid Rain

## History of acid rain in the US

## Hubbard Brook 

https://hubbardbrook.org/watersheds/watershed-6

## Solute export

```{r}

```


# Working with files in R

## The working directory

## Reading in files

## Long vs wide data

# Assignment

## Q0: 
*If you're working on this from your own computer*, set your working directory to where this file's directory. Skip this question if you are working in the Rstudio cloud IDE. *This should be the last time either group uses a full file path in this assignment.*

```{r}
setwd("~/WR 418/WR-418-assignments/ph_2")
```


## Q1:
Read in the the '.feather' data files for Q and stream chemistry at W6.

```{r}
q <- read_feather('data/w6_discharge.feather')
chem <- read_feather('data/w6_chemistry.feather')

```

## Q2: 
Make your data useful and understood.

### Part A:
Combine the chemistry and discharge data objects. Remove the columns 'ms_status', 'ms_interp', and 'val_err'.

```{r}
cq <- rbind(chem, q) %>%
    select(-c('ms_status', 'ms_interp','val_err'))
```

### Part B:
Describe (in text) the structure of your new, combined object. What are the columns and what do they contain? Is your data in a long or wide format? When does your dataset begin and end?

### Part C:
Use the 'unique()' function to list all variables represented in the dataset.
```{r}
unique(cq$var)
```


## Q3:

### Part A:
Plot a timeseries of pH at HBEF W6. Color the data by whether it is pre or post Clean Air Act Amendments of 1990, or use a vertical line to denote its passage.Make the figure look presentable, with labels, a title, and a descriptive caption.(Hint: the code for pH in this dataset is 'GN_pH'.)


```{r}
ggplot(filter(cq, var == 'GN_pH'), aes(x = datetime, y = val, color = datetime>as.POSIXct('1990-11-15')))+
    geom_line()+
    labs(y = 'W6 Stream pH',
         x = '',
         color = 'Clean Air Act Amendments of 1990')+
  scale_color_manual(values = c('black', 'red'),
                     labels = c('Pre', 'Post'))+
  theme(legend.position = 'bottom')
    
```

### Part B:
Fit two linear models, one to the data before and and the other after the passage of the Clean Air Act Amendments of 1990.Display your results using the 'summary()' function.

```{r}
# trim data
cq_model <- cq %>%
  filter(var == 'GN_pH') %>%
  select(datetime, val) %>%
  na.omit() %>%
  mutate(post_cca = 1*(datetime>as.POSIXct('1990-11-15')))

# calculate pre CCA
pre_model <-lm(cq_model$val[cq_model$post_cca==0] ~ cq_model$datetime[cq_model$post_cca==0])

summary(pre_model)

# calculate post CCA
post_model <-lm(cq_model$val[cq_model$post_cca==1] ~ cq_model$datetime[cq_model$post_cca==1])

summary(post_model)
```


## Q5
Aluminum is highly abundant (~7% of Earth's crust) and is toxic to life (with rare exceptions). The predominant form it takes in solution is pH dependent, with the Al^(2+) ion the most toxic to aquatic life. We will cover the exact mechanism of this pH dependence later in the semester. For now, let's just try and observe the effect. 

### Part A: 
Pivot your data from long format, to wide.
```{r}
cq_wide <- pivot_wider(cq, id_cols = c(datetime, site_code), 
                       names_from = var, 
                       values_from = val)
```

### Part B: 
Make a scatterplot of Al vs pH. (Hint: the code for Al in this dataset is 'GN_Al_ICP')
Make the figure look presentable, with labels, a title, and a descriptive caption. (Reminder: your final .html should *not* show warnings, messages, errors, etc.)
```{r}
ggplot(cq_wide, aes(x = GN_pH, y = GN_Al_ICP))+
    geom_point()
```

## Q6

### Part A:
What is the effect of reducing acid rain on in aluminum toxicity in W6?

### Part B:
What other factors may be acting on as a control on aluminum at W6?


## Bonus Question
Create a model describing the relationship between pH and Al at HBEF (it is not simple linear). Add your model to the graph from Q5.
```{r}
cq_model2 <- cq_wide %>%
  select(GN_Al_ICP, GN_pH) %>%
  na.omit()

model2 <- lm(log10(cq_model2$GN_Al_ICP)~cq_model2$GN_pH)
summary(model2)

ggplot(cq_model2, aes(x = GN_pH, y = GN_Al_ICP))+
    geom_point()+
    scale_y_log10()+
  geom_smooth(method = 'lm', 
              formula = y ~ x,
              se = T) +
  labs(x = 'pH',
       y = 'log([Al]) mg/l')

```
