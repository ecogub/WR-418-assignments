---
title: "Gas Flux"
author: "Nick Gubbins"
date: "2/16/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages('stream')
library(here)
library(tidyverse)
library(dataRetrieval)
library(lubridate)
library(trend)
```

# Aquatic Gases

## Oxygen

## Greenhouses

# What the flux?

## How to estimate gas flux

## Estimating **k**

## Sources and sinks

# Assignment 

## Q0:

Just like last time, let's make sure R knows where we are working. Call 'here()' to check.

```{r}
here()
```

## Q1



### Part A

Read in the 'gga_03Jun2014_f0000.txt' file from the 'data' folder. Reduce your data to only chamber methane concentrations and datetime. 

```{r}
gas <- read.csv('data/gga_03Jun2014_f0000.txt', skip = 1) %>%
  filter(!is.na(X.CH4._ppm)) %>%
  mutate(Time = mdy_hms(Time)) %>%
  select(time = Time, methane_ppm = X.CH4._ppm)
```

### Part B

Plot your data as a time series with appropriate labels. 

```{r}
ggplot(gas, aes(x = time, y = methane_ppm))+
  geom_point()+
  labs(x = 'Time', y = 'CH4 (ppm)')
```

### Part C

How many estimates of **k** can we make with our data? In other words, how many
times did the technician raise and lower the chamber?

## Q2

Let's try to estimate **k** on our own for the Yahara.

### Part A

To estimate **k** we will fit linear models to the curve right after the chamber
has been set on the water surface and the methane is diffusing at a steady rate.

The first step in doing so is excluding data from when the chamber is hanging in
the air. This is also useful as a local, atmospheric methane measurement.

Calculate a reasonable 'baseline' methane concentration for your data.

```{r}
quantile(gas$methane_ppm, .15)
# or
min(gas$methane_ppm)
```

### Part B
To estimate **k** we need to extract the sharp rises from the data, as this is
when the chamber is still reaching equilibrium. After a a certain point, the air
in the chamber will begin to saturate. This will appear in the time series as 
fluctuations in methane concentrations. We will also want to filter data while
the chamber is in the air. 

Filter your data to only the sharp rises, before the chamber begins to saturate,
and after it has been placed on the water surface. (Hint: this can either be
done through times, values, and/or a new index.)

```{r}
rises <- gas %>%
  mutate(diff = methane_ppm-lag(methane_ppm)) %>%
  filter(diff > 0,
         methane_ppm > 2.5,
         methane_ppm < 10)
```

### Part C

Plot your new, filtered dataset. Don't worry about making your plot too pretty,
just basic labels is fine.

```{r}
ggplot(rises, aes(x = time, y = methane_ppm))+
  geom_point()+
  labs(x = 'Time', y = 'CH4 (ppm)')
```

### Part D

Find the slope of each segment using a Sen's slope test (Hint: look at the Acid
Rain homework for an example of this.)

```{r}
rises <- rises %>%
  mutate(flag = if_else(time < as.POSIXct('2014-06-03 11:15', tz = 'UTC'), 1,
                        if_else(time > as.POSIXct('2014-06-03 11:25', tz = 'UTC'), 3, 2)))

m1 <- rises %>%
  filter(flag == 1) %>%
  na.omit() 

m2 <- rises %>%
  filter(flag == 2)

m3 <- rises %>%
  filter(flag == 3)

sens.slope(m1$methane_ppm)
sens.slope(m2$methane_ppm)
sens.slope(m3$methane_ppm)

```

### Part E

You run a water sample from the surface of the Yahara alongisde your chamber
measurement and find the 


